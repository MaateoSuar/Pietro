<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes | Pietro</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon-32x32.png">
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
    <header class="bg-white shadow-sm">
        <div class="w-full px-3 py-4 sm:px-4 lg:px-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">
                <span class="text-moss-500">Pietro</span>
            </h1>
            <div class="flex items-center gap-3 min-w-[260px] justify-end">
                <a href="/index.html" class="px-3 py-2 rounded bg-gray-200 hover:bg-moss-600 hover:text-white">Inicio</a>
                <a href="/Clientes" class="px-3 py-2 rounded bg-gray-200 hover:bg-moss-600 hover:text-white">Clientes</a>
                <a href="/Difusiones" class="px-3 py-2 rounded bg-gray-200 hover:bg-moss-600 hover:text-white">Difusiones</a>
                <a href="/tablero" class="px-3 py-2 rounded bg-gray-200 hover:bg-moss-600 hover:text-white">Tabla de control</a>
                <a href="/churn-view" class="px-3 py-2 rounded bg-gray-200 hover:bg-moss-600 hover:text-white">Churn</a>
                <button id="logout-btn" class="flex items-center text-gray-600 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 px-2 py-1 rounded">
                    <i data-feather="log-out" class="mr-2 w-4 h-4"></i>
                    Cerrar sesión
                </button>
            </div>
        </div>
    </header>
    
    <main class="container mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Movimientos de Clientes</h1>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contacto</label>
                    <input id="filter-contact" type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="Filtrar por contacto">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div id="clients-error" class="hidden px-4 py-2 text-sm text-red-700 bg-red-50 border-b border-red-200"></div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-moss-500 text-white">
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Fecha</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Tipo</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Vendedor</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Descripción</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Categoría de Gasto</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Contacto</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">M. de Pago</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">Valor</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="clients-table-body">
                        <!-- Movement rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="/script.js"></script>
    <script>
        feather.replace();
        // logout modal
        (function(){
          const btn = document.getElementById('logout-btn');
          if (!btn) return;
          btn.addEventListener('click', () => {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-sm';
            modal.innerHTML = `
              <h3 class="text-lg font-semibold text-gray-900 mb-2">¿Cerrar sesión?</h3>
              <p class="text-sm text-gray-600 mb-4">Se cerrará tu sesión actual.</p>
              <div class="flex justify-end gap-2">
                <button id="cancelLogout" class="px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">Cancelar</button>
                <button id="confirmLogout" class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500">Cerrar sesión</button>
              </div>`;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
            modal.querySelector('#cancelLogout').addEventListener('click', () => overlay.remove());
            modal.querySelector('#confirmLogout').addEventListener('click', () => {
              try { localStorage.removeItem('access_token'); } catch (e) {}
              window.location.href = '/login';
            });
          });
        })();
        // Load movements and render table
        (async function(){
          const tbody = document.getElementById('clients-table-body');
          if (!tbody) return;
          const token = localStorage.getItem('access_token');
          if (!token) { window.location.href='/login'; return; }
          const errorBox = document.getElementById('clients-error');
          try {
            const res = await fetch('/movimientos/', { headers: { 'Authorization': `Bearer ${token}` }});
            if (!res.ok) {
              const txt = await res.text();
              if (errorBox) { errorBox.classList.remove('hidden'); errorBox.textContent = `Error ${res.status}: ${txt}`; }
            }
            const list = res.ok ? await res.json() : [];

            function fmtDate(value){
              if (!value) return '';
              const d = new Date(value);
              if (isNaN(d.getTime())) return '';
              return d.toLocaleDateString('es-AR');
            }

            function fmtMoney(value){
              if (value == null) return '';
              const n = Number(value);
              if (isNaN(n)) return String(value);
              return n.toLocaleString('es-AR', { style:'currency', currency:'ARS' });
            }

            tbody.innerHTML = '';
            for (const m of list) {
              const tr = document.createElement('tr');
              const fullDesc = m.description || '';
              const shortDesc = fullDesc.length > 40 ? fullDesc.slice(0, 40) + '…' : fullDesc;
              tr.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${fmtDate(m.date)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.type || ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.seller || ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 max-w-xs">
                  <button type="button" class="text-left w-full truncate hover:underline description-cell" data-full="${fullDesc.replace(/"/g, '&quot;')}">
                    <span title="${fullDesc.replace(/"/g, '&quot;')}">${shortDesc}</span>
                  </button>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.expense_category || ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.contact || ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.status || ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.payment_method || ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-gray-900 font-medium">${fmtMoney(m.value)}</td>
              `;
              tbody.appendChild(tr);
            }

            // Filtro simple por contacto
            const filterInput = document.getElementById('filter-contact');
            if (filterInput) {
              filterInput.addEventListener('input', function(){
                const q = (this.value || '').toLowerCase();
                Array.from(tbody.children).forEach(tr => {
                  const contact = (tr.children[5]?.textContent || '').toLowerCase();
                  tr.style.display = !q || contact.includes(q) ? '' : 'none';
                });
              });
            }

            if (list.length === 0 && errorBox && errorBox.classList.contains('hidden')) {
              errorBox.classList.remove('hidden');
              errorBox.classList.add('text-gray-700','bg-gray-50','border-gray-200');
              errorBox.textContent = 'No hay movimientos para mostrar.';
            }
            // Modal de descripción completa
            tbody.addEventListener('click', function(e){
              const btn = e.target.closest('.description-cell');
              if (!btn) return;
              const full = btn.getAttribute('data-full') || '';
              const overlay = document.createElement('div');
              overlay.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
              const modal = document.createElement('div');
              modal.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-lg';
              modal.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Descripción completa</h3>
                <p class="text-sm text-gray-800 whitespace-pre-wrap break-words mb-4">${full}</p>
                <div class="flex justify-end">
                  <button class="px-4 py-2 rounded bg-moss-500 hover:bg-moss-600 text-white" id="closeDescModal">Cerrar</button>
                </div>
              `;
              overlay.appendChild(modal);
              document.body.appendChild(overlay);
              overlay.addEventListener('click', (ev) => { if (ev.target === overlay) overlay.remove(); });
              modal.querySelector('#closeDescModal').addEventListener('click', () => overlay.remove());
            });
          } catch(e) {
            console.error('No se pudo cargar movimientos', e);
          }
        })();
    </script>
</body>
</html>